<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puppet - Screenshot Preview</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .preview-container {
            max-width: 100%;
            overflow: auto;
        }
        .preview-img {
            max-width: 100%;
            height: auto;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        .loading {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body class="p-4">
    <div class="container mx-auto max-w-7xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-blue-800">Puppet Screenshot Preview</h1>
            <p class="text-gray-600 mt-2">Configure and preview Home Assistant dashboard screenshots</p>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Form Section -->
            <div class="lg:col-span-1 bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold text-blue-700 mb-4">Screenshot Settings</h2>

                <form id="screenshotForm" class="space-y-4">
                    <!-- Path -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Path</label>
                        <input type="text" id="path" value="/"
                            class="w-full px-3 py-2 border border-blue-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="/lovelace/0">
                    </div>

                    <!-- Viewport Width -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Viewport Width</label>
                        <input type="number" id="width" value="1000" min="100" max="4000"
                            class="w-full px-3 py-2 border border-blue-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <!-- Viewport Height -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Viewport Height</label>
                        <input type="number" id="height" value="1000" min="100" max="4000"
                            class="w-full px-3 py-2 border border-blue-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <!-- Format -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Format</label>
                        <select id="format" class="w-full px-3 py-2 border border-blue-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="png">PNG</option>
                            <option value="jpeg">JPEG</option>
                            <option value="webp">WebP</option>
                            <option value="bmp">BMP</option>
                        </select>
                    </div>

                    <!-- Theme -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Theme (optional)</label>
                        <input type="text" id="theme"
                            class="w-full px-3 py-2 border border-blue-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="e.g., Graphite E-ink Light">
                    </div>

                    <!-- Dark Mode -->
                    <div class="flex items-center">
                        <input type="checkbox" id="dark" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="dark" class="ml-2 block text-sm text-gray-700">Dark Mode</label>
                    </div>

                    <!-- Zoom -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Zoom (optional)</label>
                        <input type="number" id="zoom" step="0.1" min="0.1" max="5"
                            class="w-full px-3 py-2 border border-blue-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="1.0">
                    </div>

                    <!-- Wait Time -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Wait Time (ms, optional)</label>
                        <input type="number" id="wait" step="100" min="0"
                            class="w-full px-3 py-2 border border-blue-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="0">
                    </div>

                    <!-- Preview Button -->
                    <button type="submit"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-md transition duration-200 shadow-md hover:shadow-lg">
                        Preview Screenshot
                    </button>
                </form>

                <!-- Generated URL -->
                <div class="mt-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Generated URL</label>
                    <div class="flex gap-2">
                        <input type="text" id="generatedUrl" readonly
                            class="flex-1 px-3 py-2 bg-gray-50 border border-gray-300 rounded-md text-sm font-mono"
                            value="">
                        <button onclick="copyUrl()"
                            class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md transition duration-200">
                            Copy
                        </button>
                    </div>
                    <p id="copyFeedback" class="text-sm text-green-600 mt-1 hidden">URL copied to clipboard!</p>
                </div>
            </div>

            <!-- Preview Section -->
            <div class="lg:col-span-2 bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold text-blue-700 mb-4">Preview</h2>

                <div id="loadingIndicator" class="hidden text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent"></div>
                    <p class="mt-4 text-gray-600">Generating screenshot...</p>
                </div>

                <div id="errorMessage" class="hidden bg-red-50 border border-red-300 text-red-700 px-4 py-3 rounded-md mb-4">
                    <p class="font-semibold">Error</p>
                    <p id="errorText"></p>
                </div>

                <div class="preview-container" id="previewContainer">
                    <img id="previewImage" src="" alt="Screenshot preview will appear here" class="preview-img hidden">
                    <div id="placeholderText" class="text-center py-24 text-gray-400">
                        <svg class="mx-auto h-24 w-24 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <p class="text-lg">Click "Preview Screenshot" to generate an image</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Build URL from form parameters
        function buildUrl() {
            const path = document.getElementById('path').value || '/';
            const width = document.getElementById('width').value;
            const height = document.getElementById('height').value;
            const format = document.getElementById('format').value;
            const theme = document.getElementById('theme').value;
            const dark = document.getElementById('dark').checked;
            const zoom = document.getElementById('zoom').value;
            const wait = document.getElementById('wait').value;

            // Build query parameters
            const params = new URLSearchParams();
            params.append('viewport', `${width}x${height}`);

            if (format && format !== 'png') {
                params.append('format', format);
            }

            if (theme) {
                params.append('theme', theme);
            }

            if (dark) {
                params.append('dark', '');
            }

            if (zoom) {
                params.append('zoom', zoom);
            }

            if (wait) {
                params.append('wait', wait);
            }

            // Construct full URL
            const baseUrl = window.location.origin;
            const fullPath = path.startsWith('/') ? path : '/' + path;
            const url = `${baseUrl}${fullPath}?${params.toString()}`;

            return url;
        }

        // Update the displayed URL
        function updateUrl() {
            const url = buildUrl();
            document.getElementById('generatedUrl').value = url;
        }

        // Copy URL to clipboard
        function copyUrl() {
            const urlInput = document.getElementById('generatedUrl');
            urlInput.select();
            document.execCommand('copy');

            const feedback = document.getElementById('copyFeedback');
            feedback.classList.remove('hidden');
            setTimeout(() => {
                feedback.classList.add('hidden');
            }, 2000);
        }

        // Load preview image
        async function loadPreview(e) {
            if (e) e.preventDefault();

            const url = buildUrl();
            const previewImage = document.getElementById('previewImage');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const errorMessage = document.getElementById('errorMessage');
            const placeholderText = document.getElementById('placeholderText');

            // Show loading state
            loadingIndicator.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            previewImage.classList.add('hidden');
            placeholderText.classList.add('hidden');

            try {
                // Fetch the screenshot
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Create blob URL for the image
                const blob = await response.blob();
                const imageUrl = URL.createObjectURL(blob);

                // Display the image
                previewImage.src = imageUrl;
                previewImage.classList.remove('hidden');

            } catch (error) {
                console.error('Error loading preview:', error);
                document.getElementById('errorText').textContent = error.message;
                errorMessage.classList.remove('hidden');
                placeholderText.classList.remove('hidden');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        // Form submission handler
        document.getElementById('screenshotForm').addEventListener('submit', loadPreview);

        // Update URL when any input changes
        document.querySelectorAll('#screenshotForm input, #screenshotForm select').forEach(input => {
            input.addEventListener('input', updateUrl);
            input.addEventListener('change', updateUrl);
        });

        // Initialize URL on page load
        updateUrl();

        // Auto-load preview on page load with default settings
        window.addEventListener('load', () => {
            loadPreview();
        });
    </script>
</body>
</html>
